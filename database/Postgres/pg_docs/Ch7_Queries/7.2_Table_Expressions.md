# 7.2.4. GROUPING SETS, CUBE, and ROLLUP 

1. What is a grouping set

   A grouping set is a set of columns by which you group. It is a mechanism to
   group from multiple dimensions.
   
   brand | segment | quantity
   ------+---------+----------
   ABC   | Premium |      100
   ABC   | Basic   |      200
   XYZ   | Premium |      100
   XYZ   | Basic   |      300
   
   ```sql
   steve=#    
   
   -- This query contains 4 grouping sets
   select brand, segment, sum(quantity)  from table_foo group by grouping sets (
        (brand, segment),
        (brand),
        (segment),
        ()
      );
    brand | segment | sum
   -------+---------+-----
   
   -- grouping set: (brand, segment)
    ABC   | Premium | 100
    ABC   | Basic   | 200
    XYZ   | Premium | 100
    XYZ   | Basic   | 300
    
   -- grouping set: (brand), missing columns are set to NULL
    ABC   |         | 300
    XYZ   |         | 400
    
   -- grouping set: (segment), missing columns are set to NULL
          | Basic   | 500
          | Premium | 200
    
   -- grouping set: (), An empty grouping set means that all rows are aggregated
   -- down to a single group
          |         | 700
   (9 rows)
   ```
   
2. CUBE is a syntax sugar that will be expanded to

   ```sql
   GROUP BY cube(brand, segment)
    
   GROUP BY grouping sets (
     (brand, segment),
     (brand),
     (segment),
     ()
   );
   ```

3. ROLLUP is a syntax sugar that will be expanded to

   ```sql
   GROUP BY rollup (brand, segment)
    
   GROUP BY grouping sets (
        (brand, segment),
        (brand),
        ()
   );
   ```

   ```
   steve=#    select brand, segment, sum(quantity)  from table_foo group by rollup (brand, segment);
   brand | segment | sum
   ------+---------+-----
    XYZ  | Basic   | 300
    ABC  | Premium | 100
    ABC  | Basic   | 200
    XYZ  | Premium | 100
    ABC  |         | 300
    XYZ  |         | 400
         |         | 700
   (7 rows)
   ```
   
4. If we have multiple/nested grouping sets, a rule of thumb:

   * comma in `GROUP BY` clauses means **Cartesian product**
     
     ```
     group by rollup(brand, segment), rollup(brand, segment)
     
     -- { (brand, segment), (brand), () } X { (brand, segment), (brand), () }
     
     grouping sets (
       (brand, segment), 
       (brand, segment), 
       (brand, segment), 
       
       (brand, segment),
       (brand),
       (brand),
       
       (brand, segment)
       (brand)
       ()
     );
     
     ```
     
   * comma in `GROUPING SETS` clauses means **union**
   
     ```
     group by grouping sets (cube(brand, segment), grouping sets ((brand), (segment)))
     
     (brand, segment),
     (brand),
     (),
     
     (brand)
     (segment)
     ```